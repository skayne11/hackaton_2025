{% extends "base.html" %}
{% load static %}

{% block page_content %}

<div class="row" style="height: auto; width: auto;">
    <div style="width: 20%;" class="mr-3">
        {% include 'sidebar.html' %}
    </div>
    <div class="main-content ml-3" style="width: 75%;">
        <div id="text-chat-tab" class="tab-content">
            <h1 class="mt-3" style="color: #000000;">Compte rendu par fichier</h1>

            <!-- Chatbox pour afficher les messages et le r√©sum√© -->
            <div id="chatbox" class="border p-3 mb-3" style="height: 300px; overflow-y: auto; background: #ffffff;"></div>

            <!-- Formulaire d'upload de fichier -->
            <form id="upload-form" enctype="multipart/form-data">
                <div class="input-group">
                    <input type="file" id="file-input" class="form-control" accept=".txt">
                    <div class="input-group-append">
                        <button class="btn btn-success" type="button" onclick="uploadFile()">Envoyer le fichier</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // R√©cup√©rer le token CSRF
    const csrftoken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    async function uploadFile() {
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];

        if (!file) {
            alert("‚ùå Veuillez s√©lectionner un fichier .txt !");
            return;
        }

        // V√©rifier l'extension du fichier
        if (!file.name.endsWith('.txt')) {
            alert("‚ùå Seuls les fichiers .txt sont accept√©s !");
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            // Ajouter un message temporaire √† l'interface utilisateur
            const messagesElement = document.getElementById('chatbox');
            const userMessageElement = document.createElement('div');
            userMessageElement.className = 'alert alert-primary mt-2';
            userMessageElement.innerText = "üìÇ Fichier envoy√© : " + file.name;
            messagesElement.appendChild(userMessageElement);

            // Envoyer le fichier √† l'API Django
            const response = await fetch('/API/upload_file/', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                if (data.summary) {
                    // Afficher le r√©sum√© g√©n√©r√©
                    const botMessageElement = document.createElement('div');
                    botMessageElement.className = 'alert alert-secondary mt-2';
                    botMessageElement.innerText = "üìù R√©sum√© g√©n√©r√© : \n\n" + data.summary;
                    messagesElement.appendChild(botMessageElement);
                } else {
                    alert("‚ùå Erreur : Aucun r√©sum√© re√ßu.");
                }
            } else {
                alert("‚ùå Erreur lors de l'envoi du fichier.");
            }
        } catch (error) {
            console.error("Erreur :", error);
            alert("‚ùå Une erreur est survenue.");
        }
    }
</script>

{% endblock %}
